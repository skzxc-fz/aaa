pre_parser_v1.1.9.1:
  image: php:8.1
  stage: deploy
  script: 
    - |
      # 更新软件源并安装依赖
      apt-get update -y &&
      apt-get install -y jq git libyaml-dev wget php-dev &&  # 新增 php-dev
      
      # 安装 YAML 扩展（需 php-dev 支持）
      pecl install yaml &&
      echo "extension=yaml.so" > /usr/local/etc/php/conf.d/add-yaml-ext.ini &&  # 无需 sudo，容器内默认 root
      
      # 下载脚本文件（普通用户权限，容器内路径为 /builds/...）
      wget https://raw.githubusercontent.com/plowsof/ccs-proposal-pre-parser/3f2f73ba05a020f0c94c2b37c3f4e8050de58586/pre_parser_1.sh &&
      wget https://raw.githubusercontent.com/plowsof/ccs-proposal-pre-parser/a240380a096ddd558bfc365506d8529299fb03f3/pre_parser_2.php &&
      
      # 检查文件是否存在
      if [ ! -f "pre_parser_1.sh" ]; then
        echo "Error: pre_parser_1.sh 未下载成功"
        exit 1
      fi &&
      
      # 赋予执行权限并运行（无需 sudo，文件在当前目录）
      chmod +x pre_parser_1.sh &&
      ./pre_parser_1.sh  # 直接运行，路径正确时无需 sudo
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
